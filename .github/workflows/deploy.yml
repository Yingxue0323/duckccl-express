name: Koala CCL Node.js CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build and Deploy
      env:
        NODE_ENV: development
        PORT: 3000
        ADMIN_SECRET_KEY: ${{ secrets.ADMIN_SECRET_KEY }}
        WX_APPID: ${{ secrets.WX_APPID }}
        WX_SECRET: ${{ secrets.WX_SECRET }}
        WX_PUBLIC_KEY: ${{ secrets.WX_PUBLIC_KEY }}
        WX_PRIVATE_KEY: ${{ secrets.WX_PRIVATE_KEY }}
        WX_CERTIFICATE: ${{ secrets.WX_CERTIFICATE }}
        AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_REGION: ${{ secrets.S3_REGION }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
      run: |
        # é¦–æ¬¡åˆ›å»ºç›®å½•
        sudo mkdir -p /var/www/koala-ccl

        # ç¼–è¯‘ts
        npm run build
        echo "ç¼–è¯‘å®Œæˆï¼Œå¼€å§‹æ„å»ºğŸ ..."

         # åªåŒæ­¥å˜åŒ–çš„æ–‡ä»¶
        sudo rsync -av --delete \
        --exclude=".git" \
        --exclude="node_modules" \
        --exclude="package-lock.json" \
        dist/ /var/www/koala-ccl/dist/
        
        sudo rsync -av public/ /var/www/koala-ccl/public/
        sudo rsync -av package.json ecosystem.config.js tsconfig.json /var/www/koala-ccl/
        echo "åŒæ­¥å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ä¾èµ–æ›´æ–°ğŸ”..."

        # åªåœ¨ package.json å˜åŒ–æ—¶æ›´æ–°ä¾èµ–
        if [ -f "/var/www/koala-ccl/package.json" ] && ! cmp -s package.json /var/www/koala-ccl/package.json; then
          cd /var/www/koala-ccl
          npm install  # ä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„ package-lock.json
        fi
        echo "ä¾èµ–æ›´æ–°å®Œæˆï¼Œå¼€å§‹åˆ›å»º.envæ–‡ä»¶ğŸƒ..."

        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        env | grep -E '^(NODE_ENV|PORT|MONGODB_URI|WX_|JWT_|ADMIN_|AWS_|S3_)' > /var/www/koala-ccl/.env
        echo ".envæ–‡ä»¶åˆ›å»ºå®Œæˆï¼Œå¼€å§‹è®¾ç½®æƒé™ğŸ”’..."
        
        # è®¾ç½®æƒé™
        chmod 600 /var/www/koala-ccl/.env
        chmod -R 755 /var/www/koala-ccl
        echo "æƒé™è®¾ç½®å®Œæˆï¼Œå¼€å§‹é‡å¯åº”ç”¨ğŸ”„..."

        
        if pm2 list | grep -q "koala"; then
          pm2 reload koala --update-env
        else
          pm2 start ecosystem.config.js
        fi
        pm2 save
        echo "åº”ç”¨é‡å¯å®Œæˆâœ…"