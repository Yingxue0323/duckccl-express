name: Koala CCL Node.js CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build
      env:
        NODE_ENV: development
        PORT: 3000
        ADMIN_SECRET_KEY: ${{ secrets.ADMIN_SECRET_KEY }}
        WX_APPID: ${{ secrets.WX_APPID }}
        WX_SECRET: ${{ secrets.WX_SECRET }}
        WX_PUBLIC_KEY: ${{ secrets.WX_PUBLIC_KEY }}
        WX_PRIVATE_KEY: ${{ secrets.WX_PRIVATE_KEY }}
        WX_CERTIFICATE: ${{ secrets.WX_CERTIFICATE }}
        AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_REGION: ${{ secrets.S3_REGION }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
      run: |
        # é¦–æ¬¡åˆ›å»ºç›®å½•
        sudo mkdir -p /var/www/koala-ccl

        # ç¼–è¯‘ts
        npm run build
        echo "ç¼–è¯‘å®Œæˆï¼Œå¼€å§‹æ„å»ºğŸ ..."

        # åªåŒæ­¥å˜åŒ–çš„æ–‡ä»¶
        sudo rsync -av --delete \
        --exclude=".git" \
        --exclude="node_modules" \
        --exclude="package-lock.json" \
        dist/ /var/www/koala-ccl/dist/
        
        sudo rsync -av src/public/ /var/www/koala-ccl/dist/public/
        sudo rsync -av package.json ecosystem.config.js tsconfig.json /var/www/koala-ccl/
        echo "åŒæ­¥å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ä¾èµ–æ›´æ–°ğŸ”..."

        # åªåœ¨ package.json å˜åŒ–æ—¶æ›´æ–°ä¾èµ–
        if [ -f "/var/www/koala-ccl/package.json" ] && ! cmp -s package.json /var/www/koala-ccl/package.json; then
          cd /var/www/koala-ccl
          npm install  # ä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„ package-lock.json
        fi
        echo "ä¾èµ–æ›´æ–°å®Œæˆï¼Œå¼€å§‹åˆ›å»º.envæ–‡ä»¶ğŸƒ..."

        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        env | grep -E '^(NODE_ENV|PORT|MONGODB_URI|WX_|JWT_|ADMIN_|AWS_|S3_)' > /var/www/koala-ccl/.env
        echo ".envæ–‡ä»¶åˆ›å»ºå®Œæˆï¼Œå¼€å§‹è®¾ç½®æƒé™ğŸ”’..."
        
        # è®¾ç½®æƒé™
        sudo chmod 600 /var/www/koala-ccl/.env
        sudo chmod -R 755 /var/www/koala-ccl/dist
        sudo chown -R www-data:www-data /var/www/koala-ccl/dist/public
        sudo chown -R ubuntu:ubuntu /var/www/logs
        sudo chmod 755 /var/www/logs
        echo "æƒé™è®¾ç½®å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œç£ç›˜ç©ºé—´ğŸ” ..."

        # if pm2 list | grep -q "koala"; then
        #   pm2 reload koala --update-env
        # else
        #   pm2 start ecosystem.config.js
        # fi
        # pm2 save
        # echo "åº”ç”¨é‡å¯å®Œæˆâœ…"

    - name: Pre-deploy checks
      run: |
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶
        for file in dist/app.js ecosystem.config.js; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done

        # æ£€æŸ¥ç£ç›˜ç©ºé—´
        if [ $(df -P /var/www | awk 'NR==2 {print $5}' | sed 's/%//') -gt 90 ]; then
          echo "âŒ Disk space critical: $(df -P /var/www | awk 'NR==2 {print $5}' | sed 's/%//')%"
        fi

        # æ£€æŸ¥å†…å­˜ä½¿ç”¨
        free_mem=$(free | awk '/Mem:/ {print $4}')
        if [ $free_mem -lt 524288 ]; then  # 512MB in KB
          echo "âš ï¸ Low memory warning: $free_mem KB left"
        fi
        
        echo "æ£€æŸ¥é…ç½®æ–‡ä»¶å®Œæˆï¼Œå¼€å§‹é‡å¯åº”ç”¨ğŸ”„..."
        
    - name: restart
      run: | 
        # ä¼˜é›…åœæ­¢ç°æœ‰åº”ç”¨
        if pm2 list | grep -q "koala"; then
          echo "ğŸ›‘ æ­£åœ¨åœæ­¢ç°æœ‰åº”ç”¨..."
          pm2 stop koala
          pm2 delete koala
        fi

        # å¯åŠ¨æ–°åº”ç”¨
        echo "ğŸš€ æ­£åœ¨å¯åŠ¨åº”ç”¨..."
        pm2 start ecosystem.config.js

        # ç­‰å¾…åº”ç”¨å¯åŠ¨å¹¶æ£€æŸ¥çŠ¶æ€
        echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        max_attempts=30
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if pm2 list | grep "koala" | grep "online" > /dev/null; then
            echo "âœ… åº”ç”¨æˆåŠŸå¯åŠ¨!"
            break
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯çŠ¶æ€
          if pm2 list | grep "koala" | grep "errored" > /dev/null; then
            echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥"
            pm2 logs koala --lines 50
            exit 1
          fi
          
          echo "â³ ç­‰å¾…ä¸­... ($attempt/$max_attempts)"
          sleep 2
          attempt=$((attempt + 1))
        done

        # æ£€æŸ¥æ˜¯å¦è¶…æ—¶
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ åº”ç”¨å¯åŠ¨è¶…æ—¶"
          pm2 logs koala --lines 50
          exit 1
        fi

        # ä¿å­˜ PM2 é…ç½®
        echo "ğŸ’¾ ä¿å­˜ PM2 é…ç½®..."
        pm2 save

        echo "âœ… éƒ¨ç½²å®Œæˆ"