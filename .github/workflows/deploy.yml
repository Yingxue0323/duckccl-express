name: Koala CCL Node.js CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build and Deploy
      env:
        NODE_ENV: development
        PORT: 3000
        WX_APPID: ${{ secrets.WX_APPID }}
        WX_SECRET: ${{ secrets.WX_SECRET }}
        WX_PUBLIC_KEY: ${{ secrets.WX_PUBLIC_KEY }}
        WX_PRIVATE_KEY: ${{ secrets.WX_PRIVATE_KEY }}
        WX_CERTIFICATE: ${{ secrets.WX_CERTIFICATE }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        
      run: |
        # 清理并准备部署目录
        sudo rm -rf /var/www/koala-ccl/*  # 清理旧文件
        sudo mkdir -p /var/www/koala-ccl
        echo "清理完成，开始编译..."

        # 编译ts
        npm run build
        echo "编译完成，开始构建..."

        # 构建
        cp -r dist /var/www/koala-ccl/     # 编译后的文件
        cp -r public /var/www/koala-ccl/   # 静态文件
        cp package*.json /var/www/koala-ccl/
        cp ecosystem.config.js /var/www/koala-ccl/
        cp tsconfig.json /var/www/koala-ccl/
        echo "构建完成，开始安装依赖..."

        # 安装生产依赖
        cd /var/www/koala-ccl
        npm install
        echo "完成，开始创建环境变量文件..."

        # 创建环境变量文件
        echo "NODE_ENV=$NODE_ENV" > /var/www/koala-ccl/.env
        echo "PORT=$PORT" >> /var/www/koala-ccl/.env
        echo "MONGODB_URI=$MONGODB_URI" >> /var/www/koala-ccl/.env
        echo "WX_APPID=$WX_APPID" >> /var/www/koala-ccl/.env
        echo "WX_SECRET=$WX_SECRET" >> /var/www/koala-ccl/.env
        echo "WX_PUBLIC_KEY=$WX_PUBLIC_KEY" >> /var/www/koala-ccl/.env
        echo "WX_PRIVATE_KEY=$WX_PRIVATE_KEY" >> /var/www/koala-ccl/.env
        echo "WX_CERTIFICATE=$WX_CERTIFICATE" >> /var/www/koala-ccl/.env
        echo ".env文件创建完成，开始设置权限..."
        
        # 设置权限
        chmod 600 /var/www/koala-ccl/.env
        chmod -R 755 /var/www/koala-ccl
        echo "权限设置完成，开始重启应用..."

        # PM2 启动/重启
        echo "配置并启动 PM2..."
        if pm2 list | grep -q "koala"; then
          pm2 reload koala --update-env
        else
          pm2 start dist/app.js --name koala
        fi
        pm2 save
        echo "应用重启完成✅"